---
import { characters } from '../../data/characters';

const charMap = characters.reduce((acc, char) => {
    acc[char.id] = char;
    return acc;
}, {} as Record<string, typeof characters[0]>);
---

<div id="downloadModal" class="modal-overlay" onclick="closeModal('downloadModal')">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-close" onclick="closeModal('downloadModal')">×</div>
        
        <div class="modal-scroll-view">
            <h2 class="modal-title">游戏下载</h2>
            <div class="modal-subtitle">DOWNLOAD // WINDOWS V1.0.4</div>
            <div class="dl-grid">
                <a href="https://pan.baidu.com/s/17BaDLwHiCrhldQb1PaDmdA?pwd=3y4y" target="_blank">
                    <div class="dl-option">
                        <div class="dl-icon">❖</div>
                        <div style="font-weight:bold; color:#fff">百度云盘</div>
                        <div style="font-size:0.8rem; color:#666">提取码: 3y4y / 13.5GB</div>
                    </div>
                </a>
                <a href="https://yun.139.com/shareweb/#/w/i/2su6xyAeg2Ss2" target="_blank">
                    <div class="dl-option">
                        <div class="dl-icon">❖</div>
                        <div style="font-weight:bold; color:#fff">移动云盘</div>
                        <div style="font-size:0.8rem; color:#666">提取码: 9oft / 13.5GB</div>
                    </div>
                </a>
                <a href="https://drive.google.com/drive/folders/1rr7HY6BXE18BTJ9uSIk07KddLHUtkk4D?usp=drive_link" target="_blank">
                    <div class="dl-option">
                        <div class="dl-icon">❖</div>
                        <div style="font-weight:bold; color:#fff">Google Drive</div>
                        <div style="font-size:0.8rem; color:#666">--- / 13.5GB</div>
                    </div>
                </a>
            </div>
            <div style="margin-top:20px; font-size:0.8rem; color:#555; text-align:center;">
                * 仅支持Windows PC平台下载游玩。<a href="/wiki/turtorial/install-tutorial" target="_blank">如何安装游戏？</a>
            </div>
        </div>
    </div>
</div>

<div id="videoModal" class="modal-overlay" onclick="closeModal('videoModal')">
    <div class="modal-box" style="width: 900px;" onclick="event.stopPropagation()">
        <div class="modal-close" onclick="closeModal('videoModal')">×</div>
        
        <div class="modal-scroll-view">
            <h2 class="modal-title">正式发布PV</h2>
            <div class="modal-subtitle">OFFICIAL PROMOTION VIDEO</div>
            
            <div class="video-container">
                <iframe id="biliFrame" src="" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
            </div>
        </div>
    </div>
</div>

<div id="charModal" class="modal-overlay" onclick="closeCharModal()">
    <div class="modal-box" style="width: 1000px;" onclick="event.stopPropagation()">
        <div class="modal-close" onclick="closeCharModal()">×</div>
        
        <div class="modal-scroll-view">
            <div class="char-modal-layout">
                <div class="char-modal-img">
                    <img id="cm-img" src="" alt="Character Art">
                    <div class="grid-overlay"></div> 
                </div>
                <div class="char-modal-info">
                    <h2 id="cm-name" class="modal-title" style="font-size:2.5rem; font-style:italic;">NAME</h2>
                    <div class="modal-subtitle">
                        <span id="cm-name-en">ENGLISH NAME</span>
                        <span style="float:right; color:var(--text-white);" id="cm-role">ROLE</span>
                    </div>
                    
                    <p id="cm-desc" style="color:var(--text-main); line-height:1.6; margin-bottom:30px; min-height:60px;">Description...</p>

                    <div class="char-stat-row">
                        <div class="char-stat-label"><span>火力 (FIREPOWER)</span> <span id="stat-fire-val">A</span></div>
                        <div class="char-stat-bar"><div id="stat-fire" class="char-stat-fill"></div></div>
                    </div>
                    <div class="char-stat-row">
                        <div class="char-stat-label"><span>机动 (MOBILITY)</span> <span id="stat-mob-val">S</span></div>
                        <div class="char-stat-bar"><div id="stat-mob" class="char-stat-fill"></div></div>
                    </div>
                    <div class="char-stat-row">
                        <div class="char-stat-label"><span>防御 (DEFENSE)</span> <span id="stat-def-val">C</span></div>
                        <div class="char-stat-bar"><div id="stat-def" class="char-stat-fill"></div></div>
                    </div>
                    <div class="char-stat-row">
                        <div class="char-stat-label"><span>战术 (TACTICS)</span> <span id="stat-tac-val">B</span></div>
                        <div class="char-stat-bar"><div id="stat-tac" class="char-stat-fill"></div></div>
                    </div>

                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border-dim);">
                        <div class="char-stat-label">WEAPON PREFER</div>
                        <div id="cm-weapon" style="font-size:1.2rem; font-weight:bold; color:var(--accent-orange);">ASSAULT RIFLE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 遮罩层 */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    
    /* --- Modal Box (外壳：固定不动) --- */
    .modal-box { 
        background: var(--bg-panel); 
        border: 2px solid var(--border-dim); 
        width: 800px; max-width: 90%; 
        /* 限制最大高度，确保在小屏幕上不会溢出视口 */
        max-height: 90vh; 
        display: flex; flex-direction: column; /* 关键：让内部 scroll-view 撑满 */
        position: relative; 
        transform: translateY(50px); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
        /* 关键：Padding 设为 0，交给 scroll-view 处理 */
        padding: 0; 
        overflow: hidden; /* 防止装饰溢出 */
    }
    .modal-overlay.active .modal-box { transform: translateY(0); }

    /* 夹角装饰 (固定在 Box 上) */
    .modal-box::before { content:''; position:absolute; top:0; left:0; width:20px; height:20px; border-top: 3px solid var(--accent-orange); border-left: 3px solid var(--accent-orange); z-index: 2; pointer-events: none; }
    .modal-box::after { content:''; position:absolute; bottom:0; right:0; width:20px; height:20px; border-bottom: 3px solid var(--accent-orange); border-right: 3px solid var(--accent-orange); z-index: 2; pointer-events: none; }
    
    /* 关闭按钮 (固定在 Box 上) */
    .modal-close { 
        position: absolute; top: 10px; right: 20px; 
        font-size: 2rem; color: var(--text-sub); cursor: pointer; transition: 0.2s; font-family: var(--font-header); 
        z-index: 10; /* 保证在最上层 */
        background: rgba(0,0,0,0.5); /* 稍微加点背景防遮挡 */
        padding: 0 10px; border-radius: 4px;
    }
    .modal-close:hover { color: var(--accent-red); }

    /* --- Scroll View (内胆：负责滚动) --- */
    .modal-scroll-view {
        padding: 40px; /* 原本在 box 上的 padding 移到这里 */
        overflow-y: auto; /* 开启滚动 */
        height: 100%;
        width: 100%;
        /* 移动端平滑滚动 */
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }

    /* 内部内容样式保持不变 */
    .modal-title { font-family: var(--font-header); font-size: 2rem; margin-bottom: 10px; color: var(--text-main); }
    .modal-subtitle { color: var(--accent-orange); font-family: var(--font-tech); margin-bottom: 30px; border-bottom: 1px dashed var(--border-dim); padding-bottom: 10px; }

    /* DL Grid */
    .dl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .dl-option { border: 1px solid var(--border-dim); padding: 20px; text-align: center; transition: 0.3s; cursor: pointer; }
    .dl-option:hover { border-color: var(--accent-orange); background: rgba(255,156,0,0.1); }
    .dl-icon { font-size: 2rem; margin-bottom: 10px; color: var(--text-main); }

    /* Video */
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; background: #000; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

    /* Char Layout */
    .char-modal-layout { display: flex; gap: 40px; }
    .char-modal-img { flex: 1; height: 500px; background: #000; border: 1px solid var(--border-dim); position: relative; overflow: hidden; flex-shrink: 0; }
    .char-modal-img img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
    .char-modal-info { flex: 1.5; display: flex; flex-direction: column; }
    .char-stat-row { margin-bottom: 15px; }
    .char-stat-label { font-family: var(--font-tech); color: var(--text-sub); font-size: 0.9rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
    .char-stat-bar { width: 100%; height: 6px; background: #222; position: relative; }
    .char-stat-fill { height: 100%; background: var(--accent-orange); width: 0%; transition: 1s cubic-bezier(0.22, 1, 0.36, 1); }
    .grid-overlay { position: absolute; inset: 0; background-size: 40px 40px; background-image: linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px); pointer-events: none; z-index: 1; }

    @media (max-width: 768px) {
        .modal-box { width: 95%; height: auto; }
        .char-modal-layout { flex-direction: column; gap: 20px; }
        .char-modal-img { height: 300px; width: 100%; }
        .dl-grid { grid-template-columns: 1fr; }
        
        /* 手机端减小内边距 */
        .modal-scroll-view { padding: 25px; }
    }
</style>

<script is:inline define:vars={{ charMap }}>
    const charData = charMap;

    window.openModal = function(id) {
        const modal = document.getElementById(id);
        if(modal) {
            modal.classList.add('active');
            if(id === 'videoModal') {
                const iframe = document.getElementById('biliFrame');
                iframe.src = "//player.bilibili.com/player.html?bvid=BV13JSuBNE2S&page=1&high_quality=1&danmaku=0";
            }
        }
    }

    window.closeModal = function(id) {
        const modal = document.getElementById(id);
        if(modal) {
            modal.classList.remove('active');
            if(id === 'videoModal') {
                const iframe = document.getElementById('biliFrame');
                iframe.src = "";
            }
        }
    }

    window.openCharModal = function(key) {
        const data = charData[key];
        if(!data) return;
        
        document.getElementById('cm-name').innerText = data.name;
        document.getElementById('cm-name-en').innerText = data.nameEn;
        document.getElementById('cm-role').innerText = data.role;
        document.getElementById('cm-desc').innerText = data.desc;
        document.getElementById('cm-weapon').innerText = data.weapon;
        document.getElementById('cm-img').src = data.img;

        document.getElementById('stat-fire').style.width = data.stats[0] + '%';
        document.getElementById('stat-mob').style.width = data.stats[1] + '%';
        document.getElementById('stat-def').style.width = data.stats[2] + '%';
        document.getElementById('stat-tac').style.width = data.stats[3] + '%';
        
        const getGrade = (val) => val > 90 ? 'S' : val > 75 ? 'A' : val > 50 ? 'B' : 'C';
        
        document.getElementById('stat-fire-val').innerText = getGrade(data.stats[0]);
        document.getElementById('stat-mob-val').innerText = getGrade(data.stats[1]);
        document.getElementById('stat-def-val').innerText = getGrade(data.stats[2]);
        document.getElementById('stat-tac-val').innerText = getGrade(data.stats[3]);

        document.getElementById('charModal').classList.add('active');
    }

    window.closeCharModal = function() {
        document.getElementById('charModal').classList.remove('active');
        setTimeout(() => {
            document.querySelectorAll('.char-stat-fill').forEach(el => el.style.width = '0%');
        }, 300);
    }
</script>