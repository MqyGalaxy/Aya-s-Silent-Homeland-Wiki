---
import { locations } from '../../data/locations';
// 建议：如果图片在 src/assets 下，使用 import 引入更稳定；如果直接用字符串路径请确保有效
// import mapBgImg from '../../assets/images/game/世界地图.png'; 

import mapImg from '../../assets/images/game/世界地图.png';

const locationMap = locations.reduce((acc, loc) => {
    acc[loc.id] = loc;
    return acc;
}, {} as Record<string, typeof locations[0]>);
---

<div id="world" class="layout-grid">
    <div class="sidebar">
        <div class="sidebar-sticky">
            <span class="section-num">03</span>
            <div class="hazard-box"></div>
            <h2 class="section-title-cn">异变<br>档案</h2>
            <span class="section-title-en">Database</span>
            <p class="section-desc">
                异变爆发后的半年间，139号避难所尽可能地收集了有关异变的机密资料。
            </p>
            <div style="margin-top: 40px; font-family: var(--font-tech); color: var(--border-bright);">/// ACCESS_GRANTED</div>
        </div>
    </div>
    <div class="content-area">
        <div class="terminal-frame" id="mapContainer">
            
            <div id="mapViewport" class="map-viewport">
                <div class="grid-overlay"></div>
                
                {locations.map((loc) => (
                    <div 
                        class:list={[
                            'map-pin', 
                            { 'pin-safe': loc.type === 'safe' },
                            { 'pin-caution': loc.type === 'caution' },
                            { 'pin-warning': loc.type === 'warning' },
                            { 'pin-danger': loc.type === 'danger' }
                        ]} 
                        style={`top: ${loc.y}; left: ${loc.x};`}
                        /* 关键：添加 event 参数，用于判断是否发生过拖拽 */
                        onclick={`openMapPanel('${loc.id}', this, event)`}
                        /* 阻止鼠标按下时的默认行为，防止拖拽文字 */
                        onmousedown="event.preventDefault()"
                    >
                        <span>{loc.code}</span>
                    </div>
                ))}
            </div>
            
            <div class="location-preview" id="locPreviewBox" style="display: none;">
                <div class="preview-label">/// VISUAL FEED</div>
                <img id="locImage" src="" alt="Location Preview" />
                
                <div id="locNoSignal" class="no-signal" style="display: none;">
                    <span>NO SIGNAL</span>
                </div>

                <div class="scan-line"></div>
                <div class="corner-deco tl"></div>
                <div class="corner-deco br"></div>
            </div>

            <div class="map-data-overlay" id="mapPanel">
                <div class="close-btn" onclick="closeMapPanel()">×</div>
                <h3 style="font-family: var(--font-header); font-size: 1.5rem; margin-bottom: 20px; color: var(--text-main);">LOCATION INFO</h3>
                <div class="data-row"><span class="data-label">地点</span><span class="data-value" id="mapName">---</span></div>
                <div class="data-row"><span class="data-label">等级</span><span class="data-value" id="mapStatus">---</span></div>
                <div class="data-row"><span class="data-label">威胁</span><span class="data-value" id="mapThreat">---</span></div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-dim);">
                    <span class="data-label" style="display:block; margin-bottom:10px;">DESCRIPTION</span>
                    <p id="mapDesc" style="color: var(--text-main); font-size: 0.9rem; line-height: 1.6;">---</p>
                </div>

                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333;">
                    <button style="width: 100%; padding: 10px; background: var(--accent-orange); border: none; font-weight: bold; cursor: pointer;">ENTER WIKI</button>
                </div>
            </div>
        </div>

        <div style="margin-top: 40px; text-align: right;">
            <a href="/wiki" class="view-all-btn">
                访问数据库 <span style="margin-left: 10px;">→</span>
            </a>
        <div class="content-deco">VAULT 139 SECRET DATABASE - ACCESS HAS BEEN GRANTED</div>
    </div>
</div>

<style define:vars={{ bgUrl: `url("${mapImg.src}")` }}>
    /* 容器：作为窗口，隐藏溢出内容 */
    .terminal-frame { 
        width: 100%; 
        height: 600px; 
        border: 2px solid var(--border-dim); 
        background: #000; 
        position: relative; 
        overflow: hidden; /* 关键：隐藏超出部分 */
        cursor: grab;     /* 鼠标手势：抓取 */
        touch-action: none; /* 禁止浏览器默认滚动，完全接管触摸 */
        
        /* 滤镜变量 */
        --tint-color: transparent;
        transition: filter 0.5s ease;
    }
    
    /* 抓取中状态 */
    .terminal-frame:active {
        cursor: grabbing;
    }
    
    /* 全局滤镜层 */
    .terminal-frame::after {
        content: ''; position: absolute; inset: 0;
        background-color: var(--tint-color);
        mix-blend-mode: hard-light;
        opacity: 0; transition: opacity 0.5s ease;
        pointer-events: none; z-index: 5;
    }
    .terminal-frame.active::after { opacity: 0.2; }
    .terminal-frame.active.danger-mode { filter: grayscale(50%) contrast(120%); }
    .terminal-frame.active.danger-mode::after { opacity: 0.6; mix-blend-mode: multiply; }

    /* 地图画布：固定大尺寸 */
    .map-viewport { 
        width: 1900.5px; 
        height: 1654px; 
        position: absolute; 
        
        background-image: var(--bgUrl);
        background-size: 100% 100%; 
        background-position: center;
        transition: filter 0.5s ease; 
        will-change: transform; 
    }
    
    .grid-overlay { position: absolute; inset: 0; background-size: 40px 40px; background-image: linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px); pointer-events: none; z-index: 1; }
    
    /* --- 截图预览窗样式 --- */
    .location-preview {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 280px;
        height: 158px; /* 16:9 比例 */
        background: #000;
        border: 1px solid var(--accent-orange); /* 边框颜色会由JS动态修改 */
        z-index: 30; /* 保证在地图和滤镜之上 */
        box-shadow: 0 5px 30px rgba(0,0,0,0.8);
        pointer-events: none; /* 让点击穿透，不影响拖拽 */
        transition: border-color 0.3s;
    }
    .location-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; display: block; }
    
    .preview-label { 
        position: absolute; top: 0; left: 0; 
        background: rgba(0,0,0,0.8); padding: 2px 6px; 
        font-family: var(--font-tech); font-size: 0.7rem; color: #fff; 
        z-index: 2; letter-spacing: 1px;
    }
    
    .scan-line { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: linear-gradient(to bottom, transparent 50%, rgba(255,255,255,0.1) 51%, transparent 52%); 
        background-size: 100% 4px; pointer-events: none; z-index: 3; 
    }

    /* 无信号样式 */
    .no-signal {
        position: absolute; inset: 0;
        background-color: #111;
        display: flex; justify-content: center; align-items: center;
        color: #666;
        font-family: var(--font-tech); font-weight: bold; letter-spacing: 2px;
        z-index: 2; /* 覆盖在 img 之上 */
        /* 模拟噪点 */
        background-image: repeating-linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a), repeating-linear-gradient(45deg, #1a1a1a 25%, #111 25%, #111 75%, #1a1a1a 75%, #1a1a1a);
        background-position: 0 0, 2px 2px;
        background-size: 4px 4px;
    }
    .no-signal span { animation: blink 1s infinite; }
    
    /* 装饰角 */
    .corner-deco { position: absolute; width: 8px; height: 8px; border: 2px solid #fff; z-index: 4; }
    .tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
    .br { bottom: -1px; right: -1px; border-left: none; border-top: none; }
    
    /* 数据面板保持不变 */
    .map-data-overlay { 
        position: absolute; 
        top: 0; right: 0; 
        width: 350px; 
        height: 100%; 
        background: rgba(10,10,12,0.98); 
        border-left: 3px solid var(--accent-orange); 
        padding: 40px; 
        display: flex; flex-direction: column; 
        transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); 
        z-index: 20; backdrop-filter: blur(5px);
        overflow-y: auto;
        touch-action: pan-y;
    }
    .map-data-overlay.active { transform: translateX(0); }
    
    .data-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
    .data-label { color: var(--text-sub); font-family: var(--font-tech); font-size: 0.9rem; }
    .data-value { color: var(--text-main); font-weight: bold; font-family: var(--font-tech); }
    
    .close-btn { position: absolute; top: 15px; right: 15px; color: var(--text-sub); cursor: pointer; font-size: 24px; font-family: var(--font-header); transition: 0.2s; z-index: 50; pointer-events: auto; }
    .close-btn:hover { color: var(--accent-orange); }
    
    /* 地图点 (Pin) */
    .map-pin { 
        position: absolute; width: 40px; height: 40px; 
        background: rgba(0,0,0,0.6); 
        font-weight: bold; cursor: pointer; 
        display: flex; justify-content: center; align-items: center; 
        transform: rotate(45deg); transition: 0.3s; 
        z-index: 10;
        font-family: var(--font-tech);
        border: 2px solid var(--accent-orange);
        color: var(--accent-orange);
    }
    .map-pin span { transform: rotate(-45deg); }
    
    .map-pin:hover, .map-pin.active { 
        background-color: var(--accent-orange); color: #000; 
        box-shadow: 0 0 20px var(--accent-orange); 
        transform: rotate(45deg) scale(1.1);
    }

    .map-pin.pin-safe { border-color: #4ade80; color: #4ade80; }
    .map-pin.pin-safe:hover, .map-pin.pin-safe.active { background-color: #4ade80; color: #000; box-shadow: 0 0 20px #4ade80; }

    /* 新增：Caution (黄色) */
    .map-pin.pin-caution { border-color: #facc15; color: #facc15; }
    .map-pin.pin-caution:hover, .map-pin.pin-caution.active { background-color: #facc15; color: #000; box-shadow: 0 0 20px #facc15; }

    .map-pin.pin-danger { border-color: var(--accent-red); color: var(--accent-red); }
    .map-pin.pin-danger:hover, .map-pin.pin-danger.active { background-color: var(--accent-red); color: #000; box-shadow: 0 0 20px var(--accent-red); }

    /* 移动端适配 */
    @media (max-width: 768px) {
        .terminal-frame { height: 60vh; min-height: 400px; }
        .map-data-overlay { 
            width: 100%; max-height: 60%; top: auto; bottom: 0; right: 0; left: 0; 
            border-left: none; border-top: 3px solid var(--accent-orange); 
            transform: translateY(100%); overflow-y: scroll; 
            -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
            padding: 25px 20px; background: rgba(10, 10, 15, 0.98); 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            touch-action: pan-y;
        }
        .map-data-overlay.active { transform: translateY(0); }
        .close-btn { top: 10px; right: 15px; font-size: 1.8rem; background: rgba(0,0,0,0.5); border-radius: 4px; padding: 0 8px; z-index: 50; }
        .map-pin { width: 32px; height: 32px; font-size: 0.7rem; border-width: 1px; }
        
        /* 手机端调整截图预览框位置 */
        .location-preview { top: 10px; left: 10px; width: 140px; height: 80px; }
    }
</style>

<script is:inline define:vars={{ locationMap }}>
    const mapData = locationMap;
    
    // --- 1. 拖拽逻辑 ---
    const container = document.getElementById('mapContainer');
    const viewport = document.getElementById('mapViewport');
    const overlay = document.getElementById('mapOverlay');
    
    // 初始位置变量
    let currentX = 0, currentY = 0; 
    
    // 初始化地图位置：让 139号避难所 居中
    if (container && viewport) {
        const cw = container.offsetWidth;  // 容器宽度
        const ch = container.offsetHeight; // 容器高度
        const vw = 1900.5; // 地图真实宽度
        const vh = 1654; // 地图真实高度

        // 139号避难所的坐标比例 (来自 locations.ts: x=30%, y=40%)
        const targetXRatio = 0.75;
        const targetYRatio = 0.4;

        // 计算公式：容器中心 - 目标点在地图上的绝对坐标
        currentX = (cw / 2) - (vw * targetXRatio);
        currentY = (ch / 2) - (vh * targetYRatio);
        
        // 应用初始位置
        viewport.style.transform = `translate(${currentX}px, ${currentY}px)`;
        
        // 同步拖拽起始点
        let initialX = currentX;
        let initialY = currentY;
    }

    // ... (下面的拖拽状态变量和监听逻辑保持不变) ...
    
    let isDragging = false;
    let startX, startY;
    
    let initialX = currentX; // 确保这里能拿到初始值
    let initialY = currentY;
    let hasMoved = false;

    function onDragStart(clientX, clientY) {
        isDragging = true;
        hasMoved = false;
        startX = clientX;
        startY = clientY;
        // 每次开始拖拽前，更新基准坐标为当前位置
        initialX = currentX;
        initialY = currentY;
        
        if (container) container.style.cursor = 'grabbing';
    }

    function onDragMove(clientX, clientY) {
        if (!isDragging) return;

        const dx = clientX - startX;
        const dy = clientY - startY;

        // 防抖动阈值
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            hasMoved = true;
        }

        currentX = initialX + dx;
        currentY = initialY + dy;

        if (viewport) {
            viewport.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
    }

    function onDragEnd() {
        isDragging = false;
        if (container) container.style.cursor = 'grab';
    }

    // --- 事件监听绑定 ---

    if (container) {
        // 1. 鼠标事件 (PC)
        container.addEventListener('mousedown', (e) => {
            onDragStart(e.clientX, e.clientY);
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging) e.preventDefault();
            onDragMove(e.clientX, e.clientY);
        });

        window.addEventListener('mouseup', onDragEnd);

        // 2. 触摸事件 (Mobile) - 新增的关键部分
        container.addEventListener('touchstart', (e) => {
            if (e.target.closest('.map-data-overlay')) return;

            if (e.touches.length === 1) { 
                const touch = e.touches[0];
                onDragStart(touch.clientX, touch.clientY);
            }
        }, { passive: false }); // passive: false 允许我们调用 preventDefault

        window.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault(); // 关键：阻止页面跟随手指滚动，只让地图动
                const touch = e.touches[0];
                onDragMove(touch.clientX, touch.clientY);
            }
        }, { passive: false });

        window.addEventListener('touchend', onDragEnd);
        
        // 点击空白处关闭
        // 注意：对于触摸屏，click 事件可能会有延迟或冲突，但在简单的拖拽判断下通常够用
        container.addEventListener('click', (e) => {
            if (e.target.closest('.map-pin')) return;
            if (!hasMoved) closeMapPanel();
        });
    }

    // --- 2. 业务逻辑 (Open/Close) ---

    window.openMapPanel = function(id, el, event) {
        // 如果是拖拽结束时的误触，直接拦截
        if (hasMoved) {
            if(event) event.stopPropagation();
            return;
        }

        const data = mapData[id];
        if (!data) return;

        const mapPanel = document.getElementById('mapPanel');
        const viewport = document.getElementById('mapViewport');
        if (!mapPanel || !viewport) return;

        // 填充数据
        document.getElementById('mapName').innerText = data.name;
        document.getElementById('mapStatus').innerText = data.status;
        document.getElementById('mapThreat').innerText = data.threat;
        document.getElementById('mapDesc').innerText = data.description;
        
        // 颜色与样式
        const statusEl = document.getElementById('mapStatus');
        const overlayEl = document.getElementById('mapPanel');
        
        // 修改点：获取预览元素
        const previewBox = document.getElementById('locPreviewBox');
        const previewImg = document.getElementById('locImage');
        const noSignal = document.getElementById('locNoSignal');

        let tintColor = 'transparent';
        container.classList.remove('danger-mode');

        let activeColor = '#ff9c00'; // 用于边框颜色

        if(data.type === 'safe') {
            tintColor = '#4ade80';
            activeColor = '#4ade80';
            statusEl.style.color = 'var(--accent-green)';
            overlayEl.style.borderLeftColor = 'var(--accent-green)';
            if(window.innerWidth <= 768) overlayEl.style.borderTopColor = 'var(--accent-green)';
        } else if (data.type === 'caution') { // 新增：黄色逻辑
            tintColor = '#facc15';
            activeColor = '#facc15';
            statusEl.style.color = '#facc15';
            overlayEl.style.borderLeftColor = '#facc15';
            if(window.innerWidth <= 768) overlayEl.style.borderTopColor = '#facc15';
        } else if (data.type === 'danger') {
            tintColor = '#c91a1a';
            activeColor = '#c91a1a';
            statusEl.style.color = 'var(--accent-red)';
            overlayEl.style.borderLeftColor = 'var(--accent-red)';
             if(window.innerWidth <= 768) overlayEl.style.borderTopColor = 'var(--accent-red)';
            container.classList.add('danger-mode');
        } else {
            tintColor = '#ff9c00';
            activeColor = '#ff9c00';
            statusEl.style.color = 'var(--accent-orange)';
            overlayEl.style.borderLeftColor = 'var(--accent-orange)';
             if(window.innerWidth <= 768) overlayEl.style.borderTopColor = 'var(--accent-orange)';
        }

        container.style.setProperty('--tint-color', tintColor);
        container.classList.add('active');
        
        // --- 修改点：截图展示逻辑 ---
        previewBox.style.display = 'block'; // 显示框体
        previewBox.style.borderColor = activeColor; // 边框颜色

        if(data.screenshot) {
            // 有截图：显示图片，隐藏无信号
            previewImg.src = data.screenshot;
            previewImg.style.display = 'block';
            if(noSignal) noSignal.style.display = 'none';
        } else {
            // 无截图：隐藏图片，显示无信号
            previewImg.style.display = 'none';
            if(noSignal) noSignal.style.display = 'flex';
        }

        // Pin 高亮
        document.querySelectorAll('.map-pin').forEach(p => p.classList.remove('active'));
        if(el) el.classList.add('active');

        mapPanel.classList.add('active');
        
        if(event) event.stopPropagation();
    }

    window.closeMapPanel = function() {
        const mapPanel = document.getElementById('mapPanel');
        const vp = document.getElementById('mapViewport');
        
        if(mapPanel) mapPanel.classList.remove('active');
        
        // 修改点：关闭弹窗时隐藏预览框
        const previewBox = document.getElementById('locPreviewBox');
        if(previewBox) previewBox.style.display = 'none';

        document.querySelectorAll('.map-pin').forEach(p => p.classList.remove('active'));
        
        if(container) {
            container.classList.remove('active', 'danger-mode');
            container.style.removeProperty('--tint-color');
        }
    }
</script>