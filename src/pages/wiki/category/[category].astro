---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/layout/Header.astro';
import Footer from '../../../components/layout/Footer.astro';
import WikiSidebar from '../../../components/wiki/WikiSidebar.astro';

export async function getStaticPaths() {
  const allWiki = await getCollection('wiki');
  // 获取所有不重复的分类
  const categories = [...new Set(allWiki.map(item => item.data.category))];
  
  return categories.map(category => {
    // 获取该分类下的所有条目
    const items = allWiki.filter(item => item.data.category === category);
    return {
      params: { category },
      props: { items },
    };
  });
}

const { category } = Astro.params;
const { items } = Astro.props;

// 排序逻辑：按稀有度降序，没有稀有度的按 ID 排序
const sortedItems = items.sort((a, b) => {
    if (a.data.rarity && b.data.rarity) {
        return b.data.rarity - a.data.rarity;
    }
    return (a.data.id_code || '').localeCompare(b.data.id_code || '');
});

// 稀有度颜色辅助函数
const getRarityColor = (r) => {
    if (r === 5) return '#ffbf00'; // 金
    if (r === 4) return '#d8bfd8'; // 紫
    if (r === 3) return '#00bfff'; // 蓝
    return '#888'; // 白
};
---

<Layout title={`${category} - Wiki Database`}>
    <Header />

    <main class="wiki-category-page">
        <div class="layout-grid">
            <WikiSidebar activeCategory={category} />

            <div class="content-area">
                <div class="category-header">
                    <h1 class="category-title">
                        <span class="deco">/// </span>{category} DATABASE
                    </h1>
                    <div class="item-count">
                        Total Entries: <span class="count-val">{sortedItems.length}</span>
                    </div>
                </div>

                <div class="wiki-grid">
                    {sortedItems.map((item) => (
                        <a href={`/wiki/${item.slug}`} class="wiki-card">
                            <div class="card-visual">
                                <div class="card-img" style={`background-image: url(${item.data.cover || 'https://via.placeholder.com/300'})`}></div>
                                <div class="card-overlay"></div>
                                {item.data.id_code && <span class="card-id">{item.data.id_code}</span>}
                            </div>
                            
                            <div class="card-body">
                                <div class="card-top">
                                    {item.data.rarity && (
                                        <div class="rarity-stars" style={`color: ${getRarityColor(item.data.rarity)}`}>
                                            {'★'.repeat(item.data.rarity)}
                                        </div>
                                    )}
                                </div>
                                <h3 class="card-name">{item.data.title}</h3>
                            </div>

                            <div class="hover-corner tl"></div>
                            <div class="hover-corner br"></div>
                        </a>
                    ))}

                    </div>
                
                <div class="content-deco">DATA RETRIEVAL COMPLETE</div>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

<style>
    .wiki-category-page { padding-top: 90px; min-height: 100vh; }

    /* Header Area */
    .category-header {
        display: flex; justify-content: space-between; align-items: flex-end;
        padding-bottom: 20px; margin-bottom: 30px;
        border-bottom: 1px solid var(--border-dim);
    }
    .category-title { font-family: var(--font-header); font-size: 2.5rem; color: var(--text-main); line-height: 1; }
    .category-title .deco { color: var(--accent-orange); }
    .item-count { font-family: var(--font-tech); color: var(--text-sub); font-size: 0.9rem; }
    .count-val { color: var(--accent-orange); font-weight: bold; font-size: 1.2rem; margin-left: 5px; }

    /* --- 核心：图鉴网格 --- */
    .wiki-grid {
        display: grid;
        /* 自适应列宽：最小 220px，自动填满 */
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    .wiki-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-dim);
        display: flex; flex-direction: column;
        text-decoration: none;
        transition: all 0.2s ease;
        position: relative;
    }

    /* 悬停效果 */
    .wiki-card:hover {
        background: rgba(255,255,255,0.08);
        border-color: var(--text-sub);
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    /* 图片区域 */
    .card-visual {
        height: 140px; /* 固定高度 */
        position: relative;
        overflow: hidden;
        background: #000;
        border-bottom: 1px solid var(--border-dim);
    }
    .card-img {
        width: 100%; height: 100%;
        background-size: cover; background-position: center;
        opacity: 0.8; transition: 0.3s;
    }
    .wiki-card:hover .card-img { opacity: 1; transform: scale(1.05); }
    
    .card-id {
        position: absolute; top: 5px; right: 5px;
        background: rgba(0,0,0,0.8);
        color: var(--accent-orange);
        font-family: var(--font-tech);
        font-size: 0.7rem;
        padding: 2px 5px;
        border: 1px solid var(--accent-orange);
    }

    /* 内容区域 */
    .card-body { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    
    .card-top { margin-bottom: 5px; min-height: 16px; }
    .rarity-stars { font-size: 0.8rem; letter-spacing: 1px; text-shadow: 0 0 5px currentColor; }
    
    .card-name { 
        color: var(--text-main); font-size: 1.1rem; font-weight: bold; 
        margin: 0; line-height: 1.3;
    }
    .wiki-card:hover .card-name { color: var(--accent-orange); }

    /* 角落装饰 (Hover 显示) */
    .hover-corner { position: absolute; width: 10px; height: 10px; border: 2px solid var(--accent-orange); opacity: 0; transition: 0.2s; }
    .tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
    .br { bottom: -1px; right: -1px; border-left: none; border-top: none; }
    
    .wiki-card:hover .hover-corner { opacity: 1; }

    /* 移动端适配 */
    @media (max-width: 768px) {
        
        /* 1. 头部容器：改为垂直排列 */
        .category-header {
            flex-direction: column;
            align-items: flex-start; /* 左对齐 */
            gap: 15px; /* 标题和计数器之间的间距 */
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* 2. 标题：缩小字号，允许换行 */
        .category-title {
            font-size: 2rem; /* 原本是 2.5rem */
            line-height: 1.1;
            width: 100%;
            word-wrap: break-word; /* 防止超长单词撑破屏幕 */
        }
        
        /* 可选：让 "///" 装饰符号独占一行，看起来更像战术抬头 */
        .category-title .deco {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        /* 3. 计数器：调整位置 */
        .item-count {
            font-size: 0.8rem;
            color: var(--text-sub);
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-left: 2px solid var(--accent-orange);
            width: 100%; /* 手机上拉通显示 */
            display: flex;
            justify-content: space-between; /* 文字靠左，数字靠右 */
        }

        /* 4. 网格调整 (之前的代码可能已经有了，确保一下) */
        .wiki-grid { 
            grid-template-columns: 1fr 1fr; /* 双列 */
            gap: 10px; 
        } 
        .card-visual { height: 100px; }
        .card-body { padding: 10px; }
        .card-name { font-size: 0.9rem; }
    }
</style>